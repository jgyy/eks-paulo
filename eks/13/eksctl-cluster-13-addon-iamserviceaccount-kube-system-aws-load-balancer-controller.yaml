AWSTemplateFormatVersion: '2010-09-09'
Description: IAM role for serviceaccount "kube-system/aws-load-balancer-controller"
  [created and managed by eksctl]
Resources:
  PolicyAWSLoadBalancerController:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName:
        Fn::Sub: "${AWS::StackName}-PolicyAWSLoadBalancerController"
      Roles:
      - Ref: Role1
      PolicyDocument:
        Statement:
        - Action:
          - ec2:CreateTags
          Condition:
            'Null':
              aws:RequestTag/elbv2.k8s.aws/cluster: 'false'
            StringEquals:
              ec2:CreateAction: CreateSecurityGroup
          Effect: Allow
          Resource:
            Fn::Sub: arn:${AWS::Partition}:ec2:*:*:security-group/*
        - Action:
          - ec2:CreateTags
          - ec2:DeleteTags
          Condition:
            'Null':
              aws:RequestTag/elbv2.k8s.aws/cluster: 'true'
              aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
          Effect: Allow
          Resource:
            Fn::Sub: arn:${AWS::Partition}:ec2:*:*:security-group/*
        - Action:
          - elasticloadbalancing:CreateLoadBalancer
          - elasticloadbalancing:CreateTargetGroup
          Condition:
            'Null':
              aws:RequestTag/elbv2.k8s.aws/cluster: 'false'
          Effect: Allow
          Resource: "*"
        - Action:
          - elasticloadbalancing:AddTags
          - elasticloadbalancing:RemoveTags
          Condition:
            'Null':
              aws:RequestTag/elbv2.k8s.aws/cluster: 'true'
              aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
          Effect: Allow
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:elasticloadbalancing:*:*:targetgroup/*/*
          - Fn::Sub: arn:${AWS::Partition}:elasticloadbalancing:*:*:loadbalancer/net/*/*
          - Fn::Sub: arn:${AWS::Partition}:elasticloadbalancing:*:*:loadbalancer/app/*/*
        - Action:
          - elasticloadbalancing:AddTags
          - elasticloadbalancing:RemoveTags
          Effect: Allow
          Resource:
          - Fn::Sub: arn:${AWS::Partition}:elasticloadbalancing:*:*:listener/net/*/*/*
          - Fn::Sub: arn:${AWS::Partition}:elasticloadbalancing:*:*:listener/app/*/*/*
          - Fn::Sub: arn:${AWS::Partition}:elasticloadbalancing:*:*:listener-rule/net/*/*/*
          - Fn::Sub: arn:${AWS::Partition}:elasticloadbalancing:*:*:listener-rule/app/*/*/*
        - Action:
          - ec2:AuthorizeSecurityGroupIngress
          - ec2:RevokeSecurityGroupIngress
          - ec2:DeleteSecurityGroup
          - elasticloadbalancing:ModifyLoadBalancerAttributes
          - elasticloadbalancing:SetIpAddressType
          - elasticloadbalancing:SetSecurityGroups
          - elasticloadbalancing:SetSubnets
          - elasticloadbalancing:DeleteLoadBalancer
          - elasticloadbalancing:ModifyTargetGroup
          - elasticloadbalancing:ModifyTargetGroupAttributes
          - elasticloadbalancing:DeleteTargetGroup
          Condition:
            'Null':
              aws:ResourceTag/elbv2.k8s.aws/cluster: 'false'
          Effect: Allow
          Resource: "*"
        - Action:
          - elasticloadbalancing:RegisterTargets
          - elasticloadbalancing:DeregisterTargets
          Effect: Allow
          Resource:
            Fn::Sub: arn:${AWS::Partition}:elasticloadbalancing:*:*:targetgroup/*/*
        - Action:
          - iam:CreateServiceLinkedRole
          - ec2:DescribeAccountAttributes
          - ec2:DescribeAddresses
          - ec2:DescribeAvailabilityZones
          - ec2:DescribeInternetGateways
          - ec2:DescribeVpcs
          - ec2:DescribeSubnets
          - ec2:DescribeSecurityGroups
          - ec2:DescribeInstances
          - ec2:DescribeNetworkInterfaces
          - ec2:DescribeTags
          - ec2:DescribeVpcPeeringConnections
          - elasticloadbalancing:DescribeLoadBalancers
          - elasticloadbalancing:DescribeLoadBalancerAttributes
          - elasticloadbalancing:DescribeListeners
          - elasticloadbalancing:DescribeListenerCertificates
          - elasticloadbalancing:DescribeSSLPolicies
          - elasticloadbalancing:DescribeRules
          - elasticloadbalancing:DescribeTargetGroups
          - elasticloadbalancing:DescribeTargetGroupAttributes
          - elasticloadbalancing:DescribeTargetHealth
          - elasticloadbalancing:DescribeTags
          - cognito-idp:DescribeUserPoolClient
          - acm:ListCertificates
          - acm:DescribeCertificate
          - iam:ListServerCertificates
          - iam:GetServerCertificate
          - waf-regional:GetWebACL
          - waf-regional:GetWebACLForResource
          - waf-regional:AssociateWebACL
          - waf-regional:DisassociateWebACL
          - wafv2:GetWebACL
          - wafv2:GetWebACLForResource
          - wafv2:AssociateWebACL
          - wafv2:DisassociateWebACL
          - shield:GetSubscriptionState
          - shield:DescribeProtection
          - shield:CreateProtection
          - shield:DeleteProtection
          - ec2:AuthorizeSecurityGroupIngress
          - ec2:RevokeSecurityGroupIngress
          - ec2:CreateSecurityGroup
          - elasticloadbalancing:CreateListener
          - elasticloadbalancing:DeleteListener
          - elasticloadbalancing:CreateRule
          - elasticloadbalancing:DeleteRule
          - elasticloadbalancing:SetWebAcl
          - elasticloadbalancing:ModifyListener
          - elasticloadbalancing:AddListenerCertificates
          - elasticloadbalancing:RemoveListenerCertificates
          - elasticloadbalancing:ModifyRule
          Effect: Allow
          Resource: "*"
        Version: '2012-10-17'
  Role1:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRoleWithWebIdentity
          Condition:
            StringEquals:
              oidc.eks.ap-southeast-1.amazonaws.com/id/9CCE8A5FA3786D80C644713B35B8DB01:aud: sts.amazonaws.com
              oidc.eks.ap-southeast-1.amazonaws.com/id/9CCE8A5FA3786D80C644713B35B8DB01:sub: system:serviceaccount:kube-system:aws-load-balancer-controller
          Effect: Allow
          Principal:
            Federated: arn:aws:iam::473359703960:oidc-provider/oidc.eks.ap-southeast-1.amazonaws.com/id/9CCE8A5FA3786D80C644713B35B8DB01
        Version: '2012-10-17'
Outputs:
  Role1:
    Value:
      Fn::GetAtt: Role1.Arn