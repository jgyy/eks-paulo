AWSTemplateFormatVersion: 2010-09-09
Description: >-
  EKS nodes (AMI family: AmazonLinux2, SSH access: false, private networking:
  true) [created and managed by eksctl]
Mappings:
  ServicePrincipalPartitionMap:
    aws:
      EC2: ec2.amazonaws.com
      EKS: eks.amazonaws.com
      EKSFargatePods: eks-fargate-pods.amazonaws.com
    aws-cn:
      EC2: ec2.amazonaws.com.cn
      EKS: eks.amazonaws.com
      EKSFargatePods: eks-fargate-pods.amazonaws.com
    aws-us-gov:
      EC2: ec2.amazonaws.com
      EKS: eks.amazonaws.com
      EKSFargatePods: eks-fargate-pods.amazonaws.com
Resources:
  EgressInterCluster:
    Type: 'AWS::EC2::SecurityGroupEgress'
    Properties:
      Description: >-
        Allow control plane to communicate with worker nodes in group
        ng2-private (kubelet and workload TCP ports)
      DestinationSecurityGroupId: !Ref SG
      FromPort: 1025
      GroupId: !ImportValue 'eksctl-cluster-3-cluster::SecurityGroup'
      IpProtocol: tcp
      ToPort: 65535
  EgressInterClusterAPI:
    Type: 'AWS::EC2::SecurityGroupEgress'
    Properties:
      Description: >-
        Allow control plane to communicate with worker nodes in group
        ng2-private (workloads using HTTPS port, commonly used with extension
        API servers)
      DestinationSecurityGroupId: !Ref SG
      FromPort: 443
      GroupId: !ImportValue 'eksctl-cluster-3-cluster::SecurityGroup'
      IpProtocol: tcp
      ToPort: 443
  IngressInterClusterCP:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: >-
        Allow control plane to receive API requests from worker nodes in group
        ng2-private
      FromPort: 443
      GroupId: !ImportValue 'eksctl-cluster-3-cluster::SecurityGroup'
      IpProtocol: tcp
      SourceSecurityGroupId: !Ref SG
      ToPort: 443
  NodeGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      DesiredCapacity: '10'
      LaunchTemplate:
        LaunchTemplateName: !Sub '${AWS::StackName}'
        Version: !GetAtt 
          - NodeGroupLaunchTemplate
          - LatestVersionNumber
      MaxSize: '10'
      MinSize: '10'
      Tags:
        - Key: Name
          PropagateAtLaunch: 'true'
          Value: cluster-3-ng2-private-Node
        - Key: kubernetes.io/cluster/cluster-3
          PropagateAtLaunch: 'true'
          Value: owned
      VPCZoneIdentifier: !Split 
        - ','
        - !ImportValue 'eksctl-cluster-3-cluster::SubnetsPrivate'
    UpdatePolicy:
      AutoScalingRollingUpdate: {}
  NodeGroupLaunchTemplate:
    Type: 'AWS::EC2::LaunchTemplate'
    Properties:
      LaunchTemplateData:
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              Encrypted: false
              Iops: 3000
              Throughput: 125
              VolumeSize: 80
              VolumeType: gp3
        IamInstanceProfile:
          Arn: !GetAtt 
            - NodeInstanceProfile
            - Arn
        ImageId: ami-01c79fb7a787f5cab
        InstanceType: m5.large
        MetadataOptions:
          HttpPutResponseHopLimit: 2
          HttpTokens: optional
        NetworkInterfaces:
          - DeviceIndex: 0
            Groups:
              - !ImportValue 'eksctl-cluster-3-cluster::SharedNodeSecurityGroup'
              - !Ref SG
            NetworkCardIndex: 0
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: cluster-3-ng2-private-Node
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: cluster-3-ng2-private-Node
          - ResourceType: network-interface
            Tags:
              - Key: Name
                Value: cluster-3-ng2-private-Node
        UserData: >-
          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
      LaunchTemplateName: !Sub '${AWS::StackName}'
  NodeInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref NodeInstanceRole
  NodeInstanceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service:
                - !FindInMap 
                  - ServicePrincipalPartitionMap
                  - !Ref 'AWS::Partition'
                  - EC2
        Version: 2012-10-17
      ManagedPolicyArns:
        - !Sub >-
          arn:${AWS::Partition}:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEKSWorkerNodePolicy'
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEKS_CNI_Policy'
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore'
      Path: /
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}/NodeInstanceRole'
  SG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: >-
        Communication between the control plane and worker nodes in group
        ng2-private
      SecurityGroupIngress:
        - Description: >-
            [IngressInterCluster] Allow worker nodes in group ng2-private to
            communicate with control plane (kubelet and workload TCP ports)
          FromPort: 1025
          IpProtocol: tcp
          SourceSecurityGroupId: !ImportValue 'eksctl-cluster-3-cluster::SecurityGroup'
          ToPort: 65535
        - Description: >-
            [IngressInterClusterAPI] Allow worker nodes in group ng2-private to
            communicate with control plane (workloads using HTTPS port, commonly
            used with extension API servers)
          FromPort: 443
          IpProtocol: tcp
          SourceSecurityGroupId: !ImportValue 'eksctl-cluster-3-cluster::SecurityGroup'
          ToPort: 443
      Tags:
        - Key: kubernetes.io/cluster/cluster-3
          Value: owned
        - Key: Name
          Value: !Sub '${AWS::StackName}/SG'
      VpcId: !ImportValue 'eksctl-cluster-3-cluster::VPC'
Outputs:
  FeatureLocalSecurityGroup:
    Value: true
  FeaturePrivateNetworking:
    Value: true
  FeatureSharedSecurityGroup:
    Value: true
  InstanceProfileARN:
    Value: !GetAtt 
      - NodeInstanceProfile
      - Arn
    Export:
      Name: !Sub '${AWS::StackName}::InstanceProfileARN'
  InstanceRoleARN:
    Value: !GetAtt 
      - NodeInstanceRole
      - Arn
    Export:
      Name: !Sub '${AWS::StackName}::InstanceRoleARN'
